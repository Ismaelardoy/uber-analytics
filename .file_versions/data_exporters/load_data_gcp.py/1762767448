from mage_ai.settings.repo import get_repo_path
from mage_ai.io.config import ConfigFileLoader
from mage_ai.io.google_cloud_storage import GoogleCloudStorage
from os import path

if 'data_exporter' not in globals():
    from mage_ai.data_preparation.decorators import data_exporter


@data_exporter
def export_data_to_google_cloud_storage(data, **kwargs) -> dict:
    """
    Export transformed Parquet data to a Google Cloud Storage bucket.
    'data' should be a dict with key 'data_path' pointing to the Parquet folder.
    Configuration is loaded from 'io_config.yaml'.
    """
    # Path to io_config.yaml
    config_path = path.join(get_repo_path(), 'io_config.yaml')
    config_profile = 'default'

    # GCS target info
    bucket_name = 'uber-analytics-bucket'   # tu bucket
    object_key = 'processed/transformed_data.parquet'  # ruta dentro del bucket

    # Get path to transformed Parquet
    src_path = data.get('data_path')

    # Export to GCS
    GoogleCloudStorage.with_config(
        ConfigFileLoader(config_path, config_profile)
    ).export(
        src_path,
        bucket_name,
        object_key,
    )

    print(f"âœ… Parquet folder exported to GCS: gs://{bucket_name}/{object_key}")

    return {'gcs_path': f"gs://{bucket_name}/{object_key}"}